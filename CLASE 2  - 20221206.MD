# REPASO WINDOWS FUNCTION

## WINDOWS
> SUB CONJUNTO DE TODOS LOS REGISTROS. EN LAS VENTANAS PODEMOS HACER CALCULOS SOBRE LOS REGISTROS DE ESA VENTANA

## RANKING FUNCTIONS
> ENUMERAN LOS REGISTROS DE LA PARTICION BASADA EN UN ORDEN ESPECIFICO.

## OFFSET
> SE UTILIZA PARA OBTENER UNA COLUMNA DE UN REGISTRO QUE SE OBTIENE AL APLICAR UN DESPLAZAMIENTO DESDE EL REGISTRI ACTUAL, DENTRO DE UNA VENTANA.

> 1. **LAG(ANTERIOR):** SE REFIERE AL REGISTRO ANTERIOR DE LA FILA ACTUAL.
> 2. **LEAD(SIGUIENTE):** SE REFIERE AL REGISTRO SIGUIENTE DE LA FILA ACTUAL.
> 3. **FIRST_VALUE(SIGUIENTE):** SE REFIERE AL PRIMER REGISTRO. 
> 4. **LAST_VALUE(SIGUIENTE):** SE REFIERE AL ULTIMO REGISTRO.

> ***Nota:*** LAG, LEAD SOPORTAN LAS CLAUSULAS PARTITION Y ORDER PERO NO FRAMING.<br/> 
> ***Nota:*** AL UTILIZAR ESTOS OFFSETS EL ORDER ES IMPORTANTE PORQUE SI SE ORDENA DESC EL PRIMERO SERA EL ULTIMO ORDENADO DE FORMA NATURAL.

### PRACTICA DE OFFSETS
>  ***OBTENER LAS 3 ORDENES CON MAYOR MONTO DE FLETE***
```
SELECT * FROM (
	SELECT 
	SHIPPERID, FREIGHT, ORDERID
	 ,ROW_NUMBER() OVER(PARTITION BY SHIPPERID ORDER BY FREIGHT DESC) AS ROW_NUMBER_
	 ,RANK() OVER(PARTITION BY SHIPPERID ORDER BY FREIGHT DESC) AS RANK_
	FROM Sales.ORDERS
) T WHERE RANK_ <=3
ORDER BY SHIPPERID, FREIGHT, ORDERID
```

>  ***CALCULAR LA DIFERNECIA ENTRE EL VALOR DE LA ORDEN ACTUAL Y LA ORDEN ANTERIOR, ADEMAS DE LA ORDEN SIGUIENTE***
```
ADEMAS DE LA ORDEN SIGUIENTE
SELECT 
	ORDERID,
	VAL AS ACTUAL,
	LAG(VAL, 1,0) OVER(ORDER BY ORDERID) AS ANTERIOR,
	VAL - (LAG(VAL,1,0) OVER(ORDER BY ORDERID)) AS ACTUAL_MINUS_ANTERIOR
FROM  Sales.OrderValues
ORDER BY ORDERID
```

```
/**
* OBTENER LA RAZON SOCIAL DEL PROVEEDOR AL QUE LE REALIZAMOS LA ULTIMA COMPRA DE ESE PRODUCTO
*/
SELECT 
	C_CVE_CODIGO_PRODUCTO
	,SUM(N_CANTIDAD_COMPRA) AS CANTIDAD
	,SUM(N_CANTIDAD_COMPRA * N_COSTO_PRODUCTO) AS TOTAL
	,LAST_VALUE(c_razon_social) OVER( PARTITION BY c_razon_social  ORDER BY d_fecha_compra DESC )
FROM CONSULTAS_COMPRAS
WHERE ANIO = 2022 AND MES = 11 AND C_CVE_CODIGO_PRODUCTO = '7401069004030'
GROUP BY
	C_CVE_CODIGO_PRODUCTO
ORDER BY 
	C_CVE_CODIGO_PRODUCTO

```